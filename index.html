
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>nickf on code</title>
  <meta name="author" content="Nick Fisher">

  
  <meta name="description" content="Modular code is great. For both development and ongoing maintainence, it brings you many benefits, however most discussion in this area is focussed &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://spadgos.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="nickf on code" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25824270-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">nickf on code</a></h1>
  
    <h2>Javascript and code nerdity</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/19/using-requirejs-and-make-for-standalone-libraries/">Using RequireJS and Make for Standalone Libraries</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-19T16:38:00+02:00" pubdate data-updated="true">Oct 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Modular code is great. For both development and ongoing maintainence, it brings you many benefits, however most discussion in this area is focussed on writing modular <em>applications</em>. Modular code belongs in all parts of your development, in particular I want to talk about using it when developing a standalone library. The most popular library for client-side modules is <a href="http://requirejs.org/">RequireJS</a>, so I will focus on that.</p>

<h2>Case study</h2>

<p>A few months ago, I closed a long-standing issue on a unit test framework I built, called <a href="https://github.com/spadgos/tyrtle">Tyrtle</a>: to break the source into more manageable pieces. The code had grown to almost 1500 lines and it was getting very difficult to work on. After spending a day getting it all together, in the end I had a much simpler project which was a lot more maintainable, at the cost of a couple more kilobytes. These are some things I&rsquo;d recommend from my experience: there&rsquo;s definitely different ways to achieve the same effect, or even maybe some better practices out there, but this is what I&rsquo;ve found so far.</p>

<h2>Some important questions</h2>

<h3>Should I use modules?</h3>

<p>It depends. If your code is of a certain size (upwards of ~600 lines), then you could probably get some benefit separating the code into modules in individual files. But below this, you have to consider that it does introduce some overhead.</p>

<p>Though RequireJS is quite a large library, the author, <a href="https://github.com/jrburke">James Burke</a> has thankfully produced a minimal library which provides the same interface but just a small subset of features, which will still be fine for our purposes. This is called <a href="https://github.com/jrburke/almond">almond</a> and it&rsquo;s only 2kb after minification. If 2kb is too significant a percentage of your library&rsquo;s size, then you probably should stick to a single file.</p>

<h3>Do I check in the compiled library?</h3>

<p>This is up to you, and there are differing opinions here. My opinion on this is that you should.</p>

<p>In theory, you should be able to put your whole project on Github with a nice Makefile and README and let everyone build it for themselves, but in reality, that&rsquo;s more effort than most people are willing to invest, so most libraries provide a simple ready-to-go version somewhere in the repo.</p>

<p><em>When</em> exactly you run the build and check in the compiled version is up to you. Some libraries will do it for every commit, others only update the precompiled version when there&rsquo;s an officially tagged release. If you go with updating on each commit, make sure your users know that file is not necessarily a stable version to use.</p>

<p>You should also decide now where the compiled version of your library will live. Sometimes it&rsquo;s just in the root, other times it&rsquo;s put into a subdirectory (named <code>dist</code>, for example), especially if there are a few different versions included in each build.</p>

<p>Having the built library in the repository itself will be useful if you want your library to be used with client-side package managers such as Bower.</p>

<p>The arguments against checking in the built library are all quite valid: in general, it is considered bad practice to check in build artefacts; and it increases confusion for other developers wanting to contribute. You will just need to weigh the ease-of-use of your library against these concerns. If you did want to avoid checking in build artefacts, yet still provide a simple version for your users, one suggestion would be to create another repository for stable releases, and then also provide configuration tailored to a particular package manager (eg: a <code>component.json</code> file for Bower).</p>

<h3>Application structure</h3>

<p>Put all your source code for the library itself into a subdirectory, called <code>src</code> or similar. All other code, including the build configuration and tests all live outside, in their own directories (<code>/build</code>, <code>/tests</code>) or in the root if there&rsquo;s only one or two files.</p>

<p>Splitting up the source files into directories can follow the same guidelines you&rsquo;d use for any other project, but unless you have a very large number of modules, it is unlikely you&rsquo;ll need to go any deeper than just <code>/src</code>.</p>

<h3>AMD? CommonJS?</h3>

<p>I recommend CommonJS. For the code to run in the browser, you&rsquo;ll need to use AMD modules, but converting to AMD is simple (covered below), and lets you avoid writing meaningless boilerplate. So, just like a nodejs module, just use <code>require</code>, <code>module</code> or <code>exports</code> as if they were available in scope.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">someModule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;someModule&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">someModule</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Get the libraries</h2>

<p>Obviously in building a project with RequireJS should start with bringing in the library. Install it with <a href="https://npmjs.org/">npm</a> but make sure it&rsquo;s in your <code>package.json</code> file by using the <code>--save</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm install --save requirejs
</span></code></pre></td></tr></table></div></figure>


<p>When you install this, it will create a link to a binary of <code>r.js</code> as <code>node_modules/.bin/r.js</code>. r.js is RequireJS&rsquo;s command line tool for converting and combining files.</p>

<p>We&rsquo;ll also need almond, so <a href="https://github.com/jrburke/almond">grab the library</a> and put it into <code>/vendor</code>. We&rsquo;ll come back to this later.</p>

<h2>Write modular!</h2>

<p>Start developing your library (or converting your existing one), putting each logical module of code into its own file. When there&rsquo;s an interdependency, you specifically import the modules you need. When it comes time to run or deploy your code, you&rsquo;ll need to glue it back together, which brings us to the build step.</p>

<h2>Automating the build</h2>

<p>The overall goal here is to make your life easier, and as every good programmer knows, the key to an easy life is automation, so we&rsquo;ll configure as we go. There&rsquo;s a ton of systems you can choose for automation, including Makefiles, Cakefiles, Rakefiles, Jakefiles, GruntJS and more. For what we need, I recommend using a Makefile. It might not appear to be the most intuitive interface, but it&rsquo;s very powerful and could win purely on ubiquity. It was created in 1977, and is widely known by developers of many different languages. This benefit is not to be underestimated: there is a ton of great documentation, community knowledge and <a href="http://wiki.osdev.org/Makefile">best practices</a> to help you along the way.</p>

<p>With a good Makefile (or any other tool you choose), your project&rsquo;s build instructions should be to run one simple command, and never &ldquo;Install the node modules, then the front end modules, then copy this, then&hellip;&rdquo;.</p>

<h2>Better living through Makefiles</h2>

<p>A Makefile is a text file which defines a number of build &lsquo;targets&rsquo;, each of which could depend on different targets first. Each then lists the instructions for making that target; for example, copying files or compiling code. In general, the target is the path of a file &ndash; typically something which is created by that part of the build; otherwise any label can be given to a target. This is called a dummy target. If the target is a file and it exists on the file system and is up to date, then that step will be skipped.</p>

<p>To execute a target, you run <code>make [target]</code>, eg: <code>make build</code>, <code>make clean</code>, or simply just <code>make</code>. As a convention, the first target you should declare in a Makefile is called &lsquo;all&rsquo;. This is what is executed when invoked without a target specified &mdash; not because it&rsquo;s called &ldquo;all&rdquo; but because it&rsquo;s first.</p>

<p>One little gotcha to watch out for: the indentation is important in Makefiles, and <em>must be done with a tab character</em>. If you indent with spaces, you&rsquo;ll get a nasty and confusing error message, specifically: <code>Makefile:2: *** missing separator.  Stop.</code></p>

<p>Starting from the start, we want the <code>build</code> step to run when you type <code>make</code>. Create a file in your directory root and name it <code>Makefile</code> (with no extension) and enter this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>all: build
</span></code></pre></td></tr></table></div></figure>


<p>This declares a dummy target called <code>all</code> which depends upon another dummy target named <code>build</code>. Creating targets such as this which contain no actions of their own is fine, and can often help to split up a large build process into smaller logical steps. Now we need to define the <code>build</code> target. The <code>build</code> step can be considered done if the output library file exists and is up to date, so we can add that as a target itself. To avoid repetition, it makes things easier to use variables here. Variables can be used in the target names as well as in any commands a target defines.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># target is the final output file for your library</span>
</span><span class='line'><span class="nv">TARGET</span><span class="o">=</span>myLib.js
</span><span class='line'><span class="nv">BUILD_OPTIONS</span><span class="o">=</span>build/build.js
</span><span class='line'><span class="nv">RJS</span><span class="o">=</span>node_modules/.bin/r.js
</span><span class='line'>
</span><span class='line'>all: build
</span><span class='line'>
</span><span class='line'>build: <span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>TARGET<span class="k">)</span>:
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span><span class="k">$(</span>TARGET<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>$(BUILD_OPTIONS)</code> are for the r.js tool, and we&rsquo;ll come to that soon, but apart from that, you&rsquo;ve actually pretty much got everything you need: the files in the source directory are converted to AMD, combined and saved. Except&hellip;</p>

<h3>Declare the dependencies</h3>

<p>Remember we said that the build process should be just <code>make</code>? Nowhere in here does it <em>declare</em> that a target depends on r.js, it just assumes it&rsquo;ll be in that location. The steps to make sure this exists should be added as a target and set as a dependency where needed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>TARGET<span class="k">)</span>: <span class="k">$(</span>RJS<span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span><span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>RJS<span class="k">)</span>:
</span><span class='line'>    npm install
</span></code></pre></td></tr></table></div></figure>


<p>What this is saying is that to build myLib.js (<code>$(TARGET)</code>), it depends on a file existing in <code>node_modules/.bin/r.js</code> (<code>$(RJS)</code>). If it <em>doesn&rsquo;t</em> exist, then run <code>npm install</code>.</p>

<p><em>Now, you&rsquo;d be right in pointing out that <code>npm</code> is an undeclared dependency in this case, and that npm will in turn rely on Node. You will need to set some baseline expectation for the environment you&rsquo;re expecting it to be run in. For a javascript library, I think you&rsquo;d be safe in assuming NodeJS and NPM are available, but that&rsquo;s up to you. For applications I&rsquo;m working on at SoundCloud, we assume nothing (well, very very little) about the environment the code is executing in, and hence, the build script will actually download and compile Node and Nginx during a build. This is a good practice, since you can be guaranteed of the environment if you build it yourself, however I&rsquo;d say it&rsquo;s overkill for just a library.</em></p>

<h3>Build only when needed</h3>

<p>If you were to run this now, you&rsquo;d see the build do its thing: the node modules downloaded and then your source files would be combined and written to the output file. Sweet! Run it again, and you&rsquo;ll see a message &ldquo;make: Nothing to be done for `all&#8217;&rdquo;. This means that make has detected that everything is up to date and so it doesn&rsquo;t need to do anything &mdash; this is a key goal of a build process as it means you won&rsquo;t be wasting time downloading or rebuilding things which don&rsquo;t need it &mdash; but hang on, how does it know it&rsquo;s up to date? In this case, it is looking at the dependencies of the target and sees that you now have a file in <code>myLib.js</code> and therefore its job is done. That&rsquo;s good, but if you change one of your source files and run make, it will happily tell you there&rsquo;s nothing to be done again, leaving you with an out of date library! Bummer!</p>

<p>To fix this, we need to tell it which files will influence the build, potentially making the final file out of date, so by collecting a list of all the source files and listing them as dependencies, an update to any one of them will make the target rebuild. Rather than manually list them all (which could be tedious and error-prone), you can just use a shell command in the Makefile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">TARGET</span><span class="o">=</span>myLib.js
</span><span class='line'><span class="c"># find, in the &#39;src&#39; directory, all the files with a name ending in .js</span>
</span><span class='line'><span class="nv">SRC_FILES</span><span class="o">=</span><span class="k">$(</span>shell find src -type f -name <span class="s2">&quot;*.js&quot;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">BUILD_OPTIONS</span><span class="o">=</span>build/build.js
</span><span class='line'><span class="nv">RJS</span><span class="o">=</span>node_modules/.bin/r.js
</span><span class='line'>
</span><span class='line'>all: build
</span><span class='line'>
</span><span class='line'>build: <span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>TARGET<span class="k">)</span>: <span class="k">$(</span>RJS<span class="k">)</span> <span class="k">$(</span>SRC_FILES<span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span><span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>RJS<span class="k">)</span>:
</span><span class='line'>    npm install
</span></code></pre></td></tr></table></div></figure>


<p>Now run <code>make</code> and you&rsquo;ll see the build happening. Run it again, nothing will happen. Edit any source file, and it will build again. Perfect.</p>

<h3>Cleanliness&hellip;</h3>

<p>One final thing to mention about Makefiles (and any other build automation) is they should offer a way to restore back to a &ldquo;clean&rdquo; state, as if make had never been executed. By convention, this is defined in a target called &ldquo;clean&rdquo;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">TARGET</span><span class="o">=</span>myLib.js
</span><span class='line'><span class="nv">SRC_FILES</span><span class="o">=</span><span class="k">$(</span>shell find src -type f -name <span class="s2">&quot;*.js&quot;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">BUILD_OPTIONS</span><span class="o">=</span>build/build.js
</span><span class='line'><span class="nv">RJS</span><span class="o">=</span>node_modules/.bin/r.js
</span><span class='line'>
</span><span class='line'>all: build
</span><span class='line'>
</span><span class='line'>build: <span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'>clean:
</span><span class='line'>    rm -rf <span class="k">$(</span>TARGET<span class="k">)</span> node_modules
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>TARGET<span class="k">)</span>: <span class="k">$(</span>RJS<span class="k">)</span> <span class="k">$(</span>SRC_FILES<span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span><span class="k">$(</span>TARGET<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>RJS<span class="k">)</span>:
</span><span class='line'>    npm install
</span></code></pre></td></tr></table></div></figure>


<p>Now (once we get the r.js build options sorted), building is as simple (and as standard) as <code>make</code>.</p>

<h2>r.js build options</h2>

<p>In the Makefile, we referenced a file at <code>build/build.js</code> which contains the r.js build options and now we should fill them out.</p>

<p>These options are an extension to the requirejs configuration, for example, setting the base path of your source files, shimming non-AMD-ready third-party modules, or defining special paths for certain module names. There are several addition options for r.js</p>

<ul>
<li><code>include</code> defines a list of files to add into the build. The modules required by these files (using <code>require('some/module')</code>) will also be found by the r.js tool and automatically included in an optimal order. Here, you should include the base entry point for your library &mdash; that is, module which exports the library itself. Here is where, you can include <a href="https://github.com/jrburke/almond">almond</a>, which will provide us the basic interface needed for AMD modules to work.</li>
<li><code>optimize</code> defines which sort of minification you&rsquo;d like to use.</li>
<li><code>cjsTranslate</code> will convert CommonJS modules to AMD modules</li>
<li><code>wrap</code> is the most important part of this configuration. If you were just to combine your files into one, all would be declared in global scope, quite possibly interfering with other application code (especially so if the application is using requirejs). The <code>wrap</code> configuration lets you define fragments of code to prepend and append to the combined file, and this will be how your library is exposed to the application. Using <a href="https://github.com/umdjs/umd">UMD</a> (Universal module definition), and putting its boilerplate in these fragments, we can then cater our library to whatever environment it will be used in. More on this below.</li>
</ul>


<p><em>Thorough documentation for r.js is strangely difficult to find, but the best source I&rsquo;ve found so far is the source itself. In the r.js repo is an <a href="https://github.com/jrburke/r.js/blob/master/build/example.build.js">example build script</a> with good documentation on the options.</em></p>

<p>As an example, here are the build options used for Tyrtle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">({</span>
</span><span class='line'>  <span class="nx">include</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Tyrtle&quot;</span><span class="p">,</span> <span class="s2">&quot;../vendor/almond&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="nx">optimize</span><span class="o">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">baseUrl</span><span class="o">:</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">cjsTranslate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">wrap</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">startFile</span><span class="o">:</span> <span class="s1">&#39;wrap-start.frag.js&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">endFile</span><span class="o">:</span> <span class="s1">&#39;wrap-end.frag.js&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h3>UMD fragments</h3>

<p>The UMD pattern can be implemented by using these fragments as the wrapping files in your build.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// wrap-start.frag.js</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">define</span><span class="p">(</span><span class="nx">factory</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// change &quot;myLib&quot; to whatever your library is called</span>
</span><span class='line'>    <span class="nx">root</span><span class="p">.</span><span class="nx">myLib</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>(Your code will be inserted here.)</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">// wrap-end.frag.js</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// change &quot;my-lib&quot; to your &#39;entry-point&#39; module name </span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;my-lib&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}));</span>
</span></code></pre></td></tr></table></div></figure>


<p>To briefly explain what is happening here: it defines an IIFE which is passed root (eg: <code>window</code> in the browser), and a factory function, which returns your library. When this code is executed at the run time of the application, if that application is using a module system with <code>define</code> (AMD), or simply assigning to <code>module.exports</code> (CommonJS), your library will be accessible as a module for the application. If neither of these are used, then your library is attached to the global scope using whatever name you decide (<code>myLib</code> in the above example).</p>

<p>This style gives you a lot of flexibility, while keeping your code a good citizen which fits in to whatever is the style of the including application.</p>

<h2>Mo&#8217; builds, mo&#8217; options</h2>

<p>By modifying the options to the r.js Makefile, you can obviously produce a range of different outputs. Here&rsquo;s some common options and how they could fit into a Makefile.</p>

<h3>Production and development builds</h3>

<p>In the example r.js options above, as a unit test framework, Tyrtle had no need for minification, so the <code>optimize</code> option was set to &ldquo;none&rdquo;, since it makes the builds faster and aids debugging, but what if you wanted to provide your users with both a &lsquo;development&rsquo; and &lsquo;production&rsquo; version of your library, to save them minifying it themselves? Simple! Let&rsquo;s add a new target to the Makefile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>minify: <span class="k">$(</span>RJS<span class="k">)</span> convert
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">baseUrl</span><span class="o">=</span><span class="k">$(</span>TMP_DIR<span class="k">)</span> <span class="nv">out</span><span class="o">=</span>myLibrary.min.js <span class="nv">optimize</span><span class="o">=</span>uglify
</span></code></pre></td></tr></table></div></figure>


<h3>Mobile- or platform-specific builds</h3>

<p>If you want to provide different builds of your system with specialised code for a particular platform, this is made simple with requirejs&rsquo;s <code>path</code> configuration. Though it has many uses, you can use it to dynamically alias a module name to a particular file, and r.js allows you to change this configuration on the fly.</p>

<p>A mobile-specific build of a library might allow you to leave out large sections of code (eg: if it were optionally interfacing with Flash), or use jQuery 2.0 instead of 1.9, since supporting old IE would no longer be necessary.</p>

<p>Again, it&rsquo;s a simple one-liner in your Makefile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mobile: <span class="k">$(</span>RJS<span class="k">)</span> convert
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span>myLibrary.mobile.js paths.jquery<span class="o">=</span><span class="s2">&quot;jquery-2.0.js&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>paths</code> option passed into r.js changes which file is retrieved when using <code>require</code>. The source code would contain something like <code>$ = require('jquery')</code>, and this option changes it so that jQuery 2.0 is used.</p>

<h3>Custom lodash builds</h3>

<p>If you want to use some of the functions provided by <a href="https://github.com/jashkenas/underscore">Underscore</a>, but are wary of increasing the file size of your library, switching to <a href="http://lodash.com/">lodash</a> is a good idea, since it provides Underscore compatibility, but with a powerful <a href="http://lodash.com/custom-builds">customisable build process</a>. I won&rsquo;t go too much into the options of lodash, but here&rsquo;s an example of how you might integrate it with your Makefile.</p>

<p>Lodash is shipped as an NPM module named <code>lodash-cli</code>, and it provides an executable for generating a build, so those will need to be added as dependencies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">LODASH</span><span class="o">=</span>node_modules/lodash/build.js
</span><span class='line'><span class="nv">LODASH_MODULE</span><span class="o">=</span>vendor/lodash
</span><span class='line'><span class="nv">LODASH_LIB</span><span class="o">=</span><span class="k">$(</span>LODASH_MODULE<span class="k">)</span>.js
</span><span class='line'>
</span><span class='line'><span class="c"># to access the builder, we just need the module</span>
</span><span class='line'><span class="k">$(</span>LODASH<span class="k">)</span>:
</span><span class='line'>  npm install
</span><span class='line'>
</span><span class='line'><span class="k">$(</span>LODASH_LIB<span class="k">)</span>: <span class="k">$(</span>LODASH<span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>LODASH<span class="k">)</span> <span class="nv">include</span><span class="o">=</span>throttle,extend,bindAll <span class="nv">exports</span><span class="o">=</span>amd --output <span class="k">$(</span>LODASH_LIB<span class="k">)</span> --minify
</span><span class='line'>
</span><span class='line'>build:
</span><span class='line'>  <span class="k">$(</span>RJS<span class="k">)</span> -o <span class="k">$(</span>BUILD_OPTIONS<span class="k">)</span> <span class="nv">out</span><span class="o">=</span>myLibrary.mobile.js paths._<span class="o">=</span><span class="s2">&quot;$(LODASH_MODULE)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lodash also has a <code>mobile</code> mode which could be used in combination with a mobile-specific build to further reduce file size and increase performance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">$(</span>LODASH_LIB_MOBILE<span class="k">)</span>: <span class="k">$(</span>LODASH<span class="k">)</span>
</span><span class='line'>  <span class="k">$(</span>LODASH<span class="k">)</span> mobile <span class="nv">include</span><span class="o">=</span>throttle,extend,bindAll <span class="nv">exports</span><span class="o">=</span>amd --output <span class="k">$(</span>LODASH_LIB_MOBILE<span class="k">)</span> --minify
</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping up</h2>

<p>If you think a modular approach to building a javascript library is a good idea &mdash; and it probably is &mdash; then using requirejs and a simple Makefile will let you do everything you need with minimum fuss. There are plenty more fun things you can do in a build step, but those will have to wait for another post.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/01/soundclouds-stack-slides-from-fluentconf-and-sfjs/">SoundCloud&#8217;s Stack: Slides From FluentConf and SFJS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-01T16:16:00+02:00" pubdate data-updated="true">Jun 1<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week, I&rsquo;ve been at the <a href="http://fluentconf.com/fluent2012">Fluent Conference</a> in San Francisco. It&rsquo;s O&#8217;Reilly&rsquo;s first javascript conference, and it brought in some really large names in the field including Steve Souders, Brendan Eich, Ward Cunningham, Paul Irish, Lea Verou&hellip; and me.</p>

<p>I was doing just a short presentation on the Share Your Stack line of talks, and so I was discussing what we&rsquo;ve used and how we&rsquo;ve built <a href="http://next.soundcloud.com">The Next SoundCloud</a>. I was also quite honoured to be contacted by Dave Nugent and Andrew de Andrade from the <a href="http://www.meetup.com/jsmeetup/">San Francisco JS Users&#8217; group</a> who asked me to give a talk there too. I don&rsquo;t know why, but I was kind of expecting a medium-ish sized crowd, and that I&rsquo;d be on for 20-30 minutes or so. Turns out there were over 300 people and my slot was for an hour. Cool (gulp).</p>

<p>Anyway, I think it went really well and I got to talk to a lot of really interesting developers doing some really cool stuff. Due to popular demand, I&rsquo;m uploading the slides I used for the talk. First of all, I hope they work on your computer (interoperability wasn&rsquo;t a key concern at the time), and that they make some sense. For my actual talk, I had embedded soundcloud.com into the presentation using iframes, but this won&rsquo;t work for you unless you&rsquo;re already in the beta, so I&rsquo;ve replaced them with static images. You&rsquo;ll just have to imagine all the awesomeness of it.</p>

<p>You can take a look at the slides here: <a href="/sfjs-next-soundcloud/">SoundCloud&rsquo;s Stack</a>.</p>

<p><img src="/sfjs-next-soundcloud/logo.png" alt="" /></p>

<p>Coming shortly, I&rsquo;ll be writing a blog post for <a href="http://backstage.soundcloud.com/">SoundCloud Backstage</a>, and probably write another post here with more in-depth details about some of the techniques I spoke about in the talks.</p>

<p>PS: Due to all the people I spoke to mocking my luddite ways, I finally caved and created a Twitter account: <a href="http://twitter.com/spadgos">@spadgos</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/25/citysonar/">CitySonar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-25T19:44:00+02:00" pubdate data-updated="true">Mar 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This weekend was the <a href="http://amsterdam.musichackday.org/2012/index.php?page=Main+page">Amsterdam</a> <a href="http://musichackday.org">Music Hack Day</a>, which I was lucky enough to go along to. Although the weather seemed way too nice to spend the entire weekend indoors staring at a keyboard, <a href="http://wiki.musichackday.org/index.php?title=Amsterdam_2012_Hacks">plenty of people</a> were just as silly as me. Some of the standouts were the Theremin-controlled autotuned karaoke machine, the Bunny Boogie (where a robotic rabbit can upload recordings to SoundCloud and then will dance along to the songs you play there) and a mashup which finds popular animated gifs which match the BPM of songs in your Spotify library and synchronise the two.</p>

<p>I worked with <a href="http://twitter.com/#!a_kovalev">Sasha</a> on building an experiment we called &ldquo;<a href="http://citysonar.herokuapp.com/">CitySonar</a>&rdquo;. The concept is simple, though perhaps hard to describe in words. Let&rsquo;s try anyway:</p>

<ol>
<li>Choose a location on a map (we used Google Maps)</li>
<li>Choose a geographical feature, such as banks, schools or cafes.</li>
<li>A marker is placed on the screen for each of these features near you.</li>
<li>When you press play, a &lsquo;sonar&rsquo; sweeps around the map and plays a note for each of the markers.</li>
</ol>


<p>Markers further away are lower notes, ones closer are higher. Each different type of feature can have different characteristics for their notes, including the octave range, and the attack and release of the notes.</p>

<p><a href="http://citysonar.herokuapp.com/"><img src="https://github.com/spadgos/soundradar/raw/master/assets/screen1.png" alt="CitySonar screenshot" /></a></p>

<blockquote><p><strong>Warning full frontal nerdity:</strong> This is a client-side app, built entirely in Javascript. The only server-side component was a small NodeJS proxy to get around cross-origin security restrictions. The data was pulled from the <a href="http://wiki.openstreetmap.org/">OpenStreetMap</a> XAPI, custom map tiles provided by <a href="http://maps.stamen.com/">Stamen Maps</a>, and client-side audio generation was done by <a href="https://github.com/oampo/audiolet">Audiolet</a>.</p></blockquote>

<p>One great thing about the OpenStreetMap data is that it tracks heaps of geographic features, categorised quite granularly, so it&rsquo;s not just &ldquo;bars&rdquo; and &ldquo;cafes&rdquo; nearby, but power poles, bicycle parking, post boxes, and even brothels. Mapping these features gave some really interesting insights and some interesting results for our experiment.</p>

<p>For example, in a large city like Amsterdam, searching for <em>restaurants</em> will end up with a cacophony, as these tend to be clustered quite tightly in neighbourhoods. <em>Post boxes</em>, however are evenly spaced thoughout the city and actually can create something resembling a melody. Using features which are clustered in a single place (for example, embassies or brothels) can be used for a loud <em>hit</em> in your soundscape.</p>

<p>The quality of the project is still firmly in the &ldquo;hack&rdquo; category &mdash; it did go from idea to completion in 24 hours, remember! &mdash; but it&rsquo;s rather functional still, if you ignore some visual glitching&hellip; Also, OpenStreetMap is a community-built map and it&rsquo;s definitely not complete yet: if you see features missing in your area, don&rsquo;t forget you can go add them yourself!</p>

<p>You can check it out at <a href="http://citysonar.herokuapp.com/">http://citysonar.herokuapp.com</a>, and grab the code on <a href="https://github.com/spadgos/soundradar">GitHub</a>, but my god, the code is hacky. Please don&rsquo;t look at it. <em>Also, the API we use is very slow sometimes, so you&rsquo;ll just need to be patient sometimes.</em></p>

<h3>Bonus video</h3>

<p>Here is the recording from the presentations. CitySonar starts at 33:20.</p>

<iframe width="480" height="386" src="http://www.ustream.tv/embed/recorded/21353878" scrolling="no" frameborder="0" style="border: 0px none transparent;"></iframe>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/01/csspecific-plugin-for-sublimetext/">CSSpecific Plugin for SublimeText</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-01T16:43:00+01:00" pubdate data-updated="true">Dec 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A small post to announce a small plugin for <a href="http://www.sublimetext.com/">Sublime Text 2</a>. It&rsquo;s called <a href="https://github.com/spadgos/sublime-csspecific"><strong>CSSpecific</strong></a> and simply, it calculates the specificity of your CSS selectors.</p>

<h2>Specificiwhat?</h2>

<p>When two CSS selectors target the same element, one of them has to win, right? Deciding which one is the winner is a matter of detecting which is the <em>most specific</em>. You can read the full technical details of this in the <a href="http://www.w3.org/TR/css3-selectors/#specificity">CSS Spec</a>, but basically it works like this:</p>

<p>A specificity score is 3 values. We&rsquo;ll refer to these values as &ldquo;a,b,c&rdquo;.</p>

<blockquote><p>A selector&rsquo;s specificity is calculated as follows:</p>

<ul>
<li>count the number of ID selectors in the selector (= a)</li>
<li>count the number of class selectors, attributes selectors, and pseudo-classes in the selector (= b)</li>
<li>count the number of type selectors and pseudo-elements in the selector (= c)</li>
<li>ignore the universal selector</li>
</ul>
</blockquote>

<p>At the end, whichever has the highest score wins, reading left to right, <code>a &gt; b &gt; c</code>. Note that any number of lower-valued selectors never outvalues a higher valued selector. So, even a selector which had 1000 classes in it would be less specific than one which had a single id. <code>(0, 1000, 0) &lt; (1, 0, 0)</code></p>

<h2>The plugin</h2>

<p>So the plugin, when activated, reads all the CSS selectors from your file (even in HTML files), and collates them in a display panel alongside their score. For simplicity the score is presented as a single number: <code>a * 100 + b * 10 + c</code>, which means that if you DO have a selector with 1000 classes, this plugin will tell you that it has a higher score, but you know what? If you have a selector with more than 10 classes or elements, you got bigger problems, pal.</p>

<h2>Examples</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/* 001 */</span> <span class="nt">div</span>
</span><span class='line'><span class="c">/* 010 */</span> <span class="nc">.active</span>
</span><span class='line'><span class="c">/* 100 */</span> <span class="nf">#nav</span>
</span><span class='line'><span class="c">/* 101 */</span> <span class="nf">#nav</span> <span class="o">&gt;</span> <span class="nt">ol</span>
</span><span class='line'><span class="c">/* 012 */</span> <span class="nt">div</span> <span class="o">+</span> <span class="nt">a</span><span class="o">[</span><span class="nt">href</span><span class="o">]</span>
</span><span class='line'><span class="c">/* 002 */</span> <span class="nt">a</span><span class="nd">:active</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check it out on <a href="https://github.com/spadgos/sublime-csspecific">github</a>, let me know what you think, <a href="https://github.com/spadgos/sublime-csspecific/issues">send bug reports</a>, pull requests&hellip; all that &ldquo;social coding&rdquo; stuff.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/30/a-soundcloud-plugin-for-jekyll-slash-octopress/">A SoundCloud Plugin for Jekyll/Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-30T23:22:00+01:00" pubdate data-updated="true">Nov 30<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A little while ago, I started working at <a href="http://www.soundcloud.com/">SoundCloud</a> &mdash; it&rsquo;s a really fun place to work, and very exciting given the scale and growth of the platform there. They&rsquo;re so nice, they even put up an <a href="http://blog.soundcloud.com/2011/11/10/nick/">interview with me</a>!</p>

<p>I&rsquo;m working across the HTML5 projects which SoundCloud are producing, including the mobile site and the widget. The widget is the player which users can embed into their websites or blogs, and just recently we&rsquo;ve released the new version which is entirely based on HTML5. <em>I should mention that <strong>very</strong> little of the code was produced by me, since it was done before I started, but now I&rsquo;m working on bugfixes and further improvements.</em></p>

<p>Anyway, the key point here is that it&rsquo;s designed to be embedded on blogs. It&rsquo;s not very difficult to get the code to embed it normally &mdash; just go to any track or user or anything, and click on &ldquo;share&rdquo; &mdash; but since I&rsquo;m now on a new blogging engine which is specifically marketed as a &ldquo;hacker&rsquo;s&rdquo; blog, I thought I&rsquo;d put together a little plugin to make it even easier for those people using <a href="http://jekyllrb.com/">Jekyll</a> or <a href="http://octopress.org/">Octopress</a>.</p>

<p>It&rsquo;s actually trivially simple in the end, but the <a href="https://github.com/spadgos/spadgos.github.com/blob/source/plugins/soundcloud.rb">source is on github</a>. It&rsquo;s currently buried within my blog&rsquo;s repo, but maybe soon I&rsquo;ll move it to its own repository.</p>

<p>Using it is very simple too. The only downside currenly is that it requires you to know the relevant id if you want to embed a group, playlist, track or app widget. This information can be copied from the HTML which the SoundCloud site gives you, but it&rsquo;s not immediately obvious. Perhaps I&rsquo;ll see what we can do about that&hellip; The good news is that if you want a widget for a user&rsquo;s tracks, or <em>their</em> favorite tracks, then you can just use their username in lieu of an id.</p>

<h2>Examples</h2>

<p>Here&rsquo;s the most basic usage: a resource type (<code>users</code>, <code>favorites</code>, <code>groups</code>, <code>playlists</code>, <code>apps</code>, or <code>tracks</code>), and an id.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{% soundcloud favorites 6431392 %}</span></code></pre></td></tr></table></div></figure>




<iframe width="100%" height="450" scrolling="no" frameborder="no" src="http://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Fusers%2F6431392%2Ffavorites&amp;"></iframe>


<p>There are more options, as described in the <a href="http://developers.soundcloud.com/docs/widget">widget documentation</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{% soundcloud groups 438 color=282828 show_artwork=true %}</span></code></pre></td></tr></table></div></figure>




<iframe width="100%" height="450" scrolling="no" frameborder="no" src="http://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Fgroups%2F438&amp;color=282828&amp;show_artwork=true"></iframe>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{% soundcloud playlists 162602 show_comments=false show_playcount=false show_user=false show_artwork=false %}</span></code></pre></td></tr></table></div></figure>




<iframe width="100%" height="450" scrolling="no" frameborder="no" src="http://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Fplaylists%2F162602&amp;show_comments=false&amp;show_playcount=false&amp;show_user=false&amp;show_artwork=false"></iframe>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{% soundcloud tracks 26654081 %}</span></code></pre></td></tr></table></div></figure>




<iframe width="100%" height="166" scrolling="no" frameborder="no" src="http://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F26654081&amp;"></iframe>


<p>So there you have it. I&rsquo;ll write more soon about the sidebar plugin, and perhaps I may have organised my code better by then and you&rsquo;ll be able to get these plugins for yourself. Who knows??</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/20/a-new-beginning/">A New Beginning</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-20T14:01:00+01:00" pubdate data-updated="true">Nov 20<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Yep, it&rsquo;s a new blog! Hooray!</p>

<p>The last blog was, to be kind, <em>crap</em>. It was something I&rsquo;d just thrown together to get it working. I chose a standard off-the-shelf wordpress theme, and that was about the limit of the effort I spent getting it set up. For someone who writes about the web, it was an embarassment, really.</p>

<p>Anyway, <strong>that was the past</strong>!</p>

<p>I&rsquo;ve now set up with a new blogging engine, <a href="http://octopress.org/">Octopress</a>, which is built on top of <a href="http://jekyllrb.com/">Jekyll</a>. It&rsquo;s described as a &ldquo;hacker&rsquo;s&rdquo; blog &mdash; you write the content in a language such as markdown or textile, and then Octopress parses and converts it into static HTML pages. From there, you publish via <code>rsync</code> or, what I&rsquo;m doing now, pushing to a github repository. Deployment via version control seems so very right, you know?</p>

<p>Despite my comments about the stock-standardness of my previous blog, the current one is still using the default packaged theme, but I&rsquo;ll get onto that shortly, I swear. I&rsquo;ll also look into migrating (and perhaps vetting) the posts from the old blog too.</p>

<p>Exciting times for a nerd.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/01/sublime-text-and-jsdocs/">Sublime Text &amp; JSDocs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-01T23:37:00+01:00" pubdate data-updated="true">Nov 1<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, I’ve had one of those events in my professional life. They happen (for me) even less frequently than changing jobs. Yes, I have changed my preferred text editor. gasp!</p>

<p>I’ve moved from <a href="http://www.activestate.com/komodo-edit">Komodo</a>, which is a very competent and extensible (with Javascript!) editor, to the new kid on the block, <a href="http://www.sublimetext.com/">Sublime Text 2</a>. Sublime is a product still in beta, but I can recommend it as being definitely stable enough for every day use.</p>

<p><em>I’ll apologise up front if the following sounds too gushing or like an advertising pitch. I have no commercial interest in the product whatsoever, I actually just really like it and want others to try it out.</em></p>

<p>When starting with Sublime, the first thing you’ll notice is how amazingly fast it is. I am still amazed at how quickly it starts and continues to be, even on my little old netbook. The second thing is that you’ll see that Sublime is a text editor made by programmers for programmers. The default colour scheme is a very pleasing and eye-friendly pastels on dark grey, the interface is absolutely no-nonsense: no toolbars; no buttons for new file, save, cut, copy or paste; just one menu bar, an (albeit slightly gimmicky IMO) “minimap” of the file, and your code. All commands are available from a “command palette” which is opened via a key binding. Similarly, opening project files or searching for functions is done with another palette. These palettes, apart from being super-quick, also provide fuzzy text matching. For example, to make the selected text upper case, I just select the text, then press <code>Ctrl+Shift+P</code>, and type “chup”, which will find “CHange text to UPper case”, or if I want to open “lib/test/PolygonTest.js”, <code>Ctrl+P</code> and “l/t/p” or “PolTe” or whatever narrows it down enough with the minimum amount of typing. Everything is possible without even touching your mouse.</p>

<p><span class='pullquote-right' data-pullquote='every day you build complex data-structures capable of modelling anything by combining numbers and strings into nested arrays and maps — why couldn’t you configure a text editor in the same way?'>Probably the most surprising thing is the configuration settings. Every programmer worth his salt will fiddle and adjust settings to get the work environment Just Right, and usually this means poring through dialog after dialog of checkboxes and pull-downs. In Sublime, all the configuration (yes, ALL) is done via JSON text files. This is shocking at first, but amazingly liberating once you start to use it. As a programmer, every day you build complex data-structures capable of modelling anything by combining numbers and strings into nested arrays and maps — why couldn’t you configure a text editor in the same way? Settings are applied instantly upon save, meaning you can test out each of the settings very easily and get it just how you like it. Even key bindings are handled this way. Every interaction you have, from moving the cursor, to basic copy/paste/save actions, even to what happens when you click a mouse button is configurable. Even better though is that you can bind the same key combo to several actions and then affix conditions (referred to as “context” in the config) to that setting. For example, the “enter” key can add a new line in regular text, but you can also add another binding which makes it prepend commenting characters (<code>//</code>) if the current context is a comment. Triple-click might normally select a line, but if it’s on a function definition it could select the entire function body for you. After all this tweaking, you can commit your plain-text settings to version control for portability between your workstations, which is very handy!</span></p>

<p>One other feature I’ve not seen in any other editor is multiple selections. Komodo and other editors (VI, Emacs…) have “block editing” where you can make rectangular selections and edits across rows and columns. This is particularly useful for modifying blocks of repetitive code which happen to align vertically. Sublime takes that a step further by allowing for multiple selections. It is surprisingly useful for reformatting code, and as a replacement for Find-and-Replace. Just select (let’s say) the variable you want to rename, and hit <code>Ctrl+D</code>. The next occurrence of that word will get selected. Repeat as often as you like, the just start typing and you’ll be typing in multiple discrete locations. This feature alone has reduced the amount of macros and regexes I use to clean up text drastically. You’ll wonder how you lived without it, seriously.</p>

<p>The last thing I want to mention is the fledgling, but fast-growing developer community around Sublime. As a tool for programmers, its been designed to be extended with plugins, written in Python. What’s even better is that there’s a package repository plugin called <a href="https://github.com/wbond/sublime_package_control">Package Control</a>, written by <a href="https://github.com/wbond">Will Bond</a>, that completely streamlines the plugin installation and upgrade process integrated directly into the editor. Plugins are hosted on Github or Bitbucket and you can pull the upgrades as their published. After installing that package (which you can do just by pasting a command into the integrated python shell..!), all the available packages are shown in a command palette, and are installed without even requiring a restart. Since the code for the plugins is on Github, it’s really easy to fork it and send in pull requests if you find a bug, too. I highly recommend it!</p>

<p>And there’s just enough time for a quick little shout-out for one of my own plugins. If you’re writing Javascript or PHP with Sublime, you should totally install the <a href="http://github.com/spadgos/sublime-jsdocs">JSDocs plugin</a>. You can install it with the aforementioned Package Control plugin, or there’s instructions on the Github page. This plugin makes writing Javadoc-style comments a breeze by adding context-sensitive autocompletes, comment-aware linebreaking, and it even inspects your code to prefill <code>@param</code> and <code>@return</code> tags in a docblock. The readme file has much more information and many examples. If you run into any problems, leave me a note in the issue tracker and I’ll get right onto it!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/22/converting-arguments-into-an-array/">Converting Arguments Into an Array</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-22T23:46:00+02:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been working on the previously-mentioned <a href="http://www.github.com/spadgos/myrtle">Myrtle</a> project, as well as its unit-testing sister project, <a href="http://www.github.com/spadgos/tyrtle">Tyrtle</a> (which will get further plugs soon&hellip;), and I kind of stumbled across this interesting little thing.</p>

<p>In javascript, there&rsquo;s a &ldquo;magic&rdquo; variable made available inside every function, called <code>arguments</code>. It appears to be an array at first glance, but it isn&rsquo;t. Observe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">];</span> <span class="c1">// a real array, for comparison</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">typeof</span> <span class="nx">arguments</span><span class="p">;</span> <span class="c1">// &quot;object&quot;</span>
</span><span class='line'>    <span class="k">typeof</span> <span class="nx">arr</span><span class="p">;</span>       <span class="c1">// &quot;object&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// 2</span>
</span><span class='line'>    <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>       <span class="c1">// 2</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>     <span class="c1">// &quot;x&quot;</span>
</span><span class='line'>    <span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>           <span class="c1">// &quot;x&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">typeof</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>  <span class="c1">// &quot;undefined&quot; !!!</span>
</span><span class='line'>    <span class="k">typeof</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>        <span class="c1">// &quot;function&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// &quot;[object Arguments]&quot;  !!!</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// &quot;[object Array]&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">f</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is actually a special type of object called <code>Arguments</code>, and it&rsquo;s documented well on the <a href="https://developer.mozilla.org/en/JavaScript/Reference/functions_and_function_scope/arguments">Mozilla Developer Network</a>. Essentially, it is just an enumerable object in that it has a <code>.length</code> property and other properties in the slots <code>0...length - 1</code>, but it doesn&rsquo;t have <code>Array</code> as its prototype, and hence, it doesn&rsquo;t have any of the array functions on it.</p>

<p>Obviously, in most cases where you want to actually do something useful with the arguments object, you actually want to have an array, rather than this strange object. Converting it to an array is usually done like so (as is recommended in the MDN article linked above):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">argsAsARealArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works. If you really wanted to be pedantic about it, you could say that it isn&rsquo;t actually safe, in case some code overwrites <code>Array.prototype.slice</code>, but I digress. In any case, it&rsquo;s a lot of typing and can be very confusing to both newbies.</p>

<blockquote><p>Now, in the interests of openness, I should say that I originally wrote this post to talk about this <em>amazing</em> new technique I discovered: <code>[].concat(arguments)</code>. I wrote benchmarks and everything. It was shorter and performed about 4x better on Firefox. Then I actually used it in my code and discovered that <strong>it doesn&rsquo;t even work</strong>. So, there you go. I thought I&rsquo;d keep the bulk of this article and instead compare some other methods which actually do work&hellip;</p></blockquote>

<p>I wrote some functions which convert their arguments to an array and then return it. The first two both use slice, but I wanted to see if there was a difference between creating an array literal or using the prototype <em>(spoiler: there isn&rsquo;t)</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">arrayProtoSlice</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">arrayLiteralSlice</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">splice</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[].</span><span class="nx">splice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">push</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="nx">x</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">unshift</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="nx">x</span><span class="p">.</span><span class="nx">unshift</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The results were interesting. I tested by calling each of the above functions with 1000 arguments.</p>

<pre><code>Operations/second; the higher the better
Browser         Slice    Splice    Push    Unshift
Firefox 6.0.2    4044     3549    10068      9846
Chrome 13       37814     2701    38180     40952
</code></pre>

<p>Yes, some of these numbers are bizarre, but they&rsquo;re not typos. Push/unshift is 250% faster than slice on Firefox, and only about 10% faster on Chrome. Yes, splice is 94% slower than any other method on Chrome &mdash; even slower than Firefox in this test. Unshift out-performs Push on Chrome by about 8%, too.</p>

<p>Of course, the real benefit of <code>[].slice.apply(arguments)</code> is that it&rsquo;s a one-liner. In real life usage, at best, the push/unshift technique requires 2 lines, but could be extracted to an external function. Of course, adding another function call is not free, so I did another benchmark.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">convertWithPush</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="nx">x</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">pushWithFnCall</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">convertWithPush</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// and the same for unshift</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Chrome, the extra function call led to a ~33% slow down. It did not seem to affect Firefox&rsquo;s performance at all, however.</p>

<p>In summary:</p>

<ul>
<li>If you want a simple one liner, go with: <code>var args = [].slice.apply(arguments)</code></li>
<li>If you want better performance, use: <code>var args = []; args.push.apply(args, arguments)</code></li>
<li>Never use splice</li>
</ul>


<p>Please do <a href="http://jsperf.com/converting-arguments-to-an-array">run the tests</a> yourself (and <a href="http://jsperf.com/converting-arguments-to-an-array/2">here for version 2</a> which has the additional benchmarks). Let me know if I&rsquo;ve forgotten a different method, or if I&rsquo;ve stuffed up my tests somehow.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/11/introducing-myrtle-a-javascript-mocking-framework/">Introducing Myrtle: A Javascript Mocking Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-11T23:46:00+02:00" pubdate data-updated="true">Aug 11<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m writing to introduce a small project I&rsquo;ve just put together. I call it <strong>Myrtle</strong> <em>(which I guess is some sort of play on words on the <a href="http://en.wikipedia.org/wiki/Mock_Turtle">Mock Turtle</a>)</em>, but in any case, it is a Javascript Mocking Framework!</p>

<p>The project code is available on <a href="https://github.com/spadgos/myrtle">Github</a>, or you can just grab <a href="https://raw.github.com/spadgos/myrtle/master/Myrtle.js">Myrtle.js</a> if you like.</p>

<p>So anyway, let&rsquo;s look at what it does. Let&rsquo;s say you&rsquo;re writing some tests for your code, and you want to check that a particular function is called. For example, you might have a Validator class which should be called when a form input is changed. Here&rsquo;s the signature of a basic validation class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * @param {DOMElement} a HTML Input element</span>
</span><span class='line'><span class="cm">     * @param {String} a value to validate</span>
</span><span class='line'><span class="cm">     * @return {Boolean} If the value was valid.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">validate</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">inputValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// code here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first step is to spy on the validate method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">Validator</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Spying on a method modifies it so that metadata about that method is stored with each call to it, without changing the actual functionality. You can access this metadata through the API object returned by <code>Myrtle.spy</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">Validator</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nx">myInputElement</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;a changed value&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// let&#39;s check that validate was called</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">callCount</span><span class="p">();</span> <span class="c1">// 1</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// and let&#39;s see what it returned</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">lastReturn</span><span class="p">();</span> <span class="c1">// true</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// and let&#39;s check what the parameters passed to it were</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">lastArgs</span><span class="p">();</span> <span class="c1">// [myInputElement, &quot;a changed value&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s important to remember here is that the validate method is still executed as if nothing ever happened. Myrtle wouldn&rsquo;t be a good spy otherwise&hellip;</p>

<p>Other times you want to actually stop functions from running. For example, in a test environment, you might want to suppress error messages which you&rsquo;re triggering on purpose, or to stop AJAX functions from executing. In these cases, you can stub out a function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Myrtle</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">Notifications</span><span class="p">,</span> <span class="s1">&#39;displayError&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This replaces the <code>displayError</code> method with a function which does nothing. Care should be taken in these cases that other code isn&rsquo;t expecting a return value from functions which you stub out completely.</p>

<p>You can also replace a function using stub. This is useful if you want to simulate a method, but not actually execute it &ndash; for example, when an AJAX method is called, you can put together a fake response.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Myrtle</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">Network</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">origFn</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">({</span><span class="nx">isSuccess</span> <span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll see there that the first parameter passed to the stub function is the original method. This is useful in cases where you may want to only stub it out based on some criteria, or to modify arguments or return values of the original method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Myrtle</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">Notifications</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;displayError&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span> <span class="p">(</span><span class="nx">origFn</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span> <span class="o">!==</span> <span class="s1">&#39;My expected error&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">origFn</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last feature currently in Myrtle is some basic speed profiling. If you want to find out how fast your function is executed, or if it runs slower given some input, you can turn on profiling and find out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">.</span><span class="nx">profile</span><span class="p">(</span><span class="nx">calc</span><span class="p">,</span> <span class="s1">&#39;factorial&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">calc</span><span class="p">.</span><span class="nx">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'><span class="nx">calc</span><span class="p">.</span><span class="nx">factorial</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'><span class="nx">calc</span><span class="p">.</span><span class="nx">factorial</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">getAverageTime</span><span class="p">();</span> <span class="c1">// a number, like 12 (ms)</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">getQuickest</span><span class="p">();</span> <span class="c1">// { args : [3], ret : 6, time: 1 }</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">getSlowest</span><span class="p">();</span> <span class="c1">// { args: [12], ret: 479001600, time: 20 }</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those are the three main features of Myrtle (so far). However, the nice thing about them is that they can all be combined in any way. You can spy on and stub out a method, or spy and profile. Stubbing and profiling probably isn&rsquo;t so useful though, since you&rsquo;d only be measuring the speed of performing your replacement method.</p>

<p>There are a few ways to combine the options, and it&rsquo;s important to know that each of the Myrtle functions returns the <em>exact same</em> API object per function. To demonstrate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">info1</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">Obj</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">);</span>  <span class="c1">// turn on spying</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">info2</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">Obj</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">);</span> <span class="c1">// turn on stubbing</span>
</span><span class='line'><span class="nx">info1</span> <span class="o">===</span> <span class="nx">info2</span><span class="p">;</span> <span class="c1">// true</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s also the <code>Myrtle</code> function itself which can be used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">Myrtle</span><span class="p">(</span><span class="nx">Obj</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">spy</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">stub</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// my replacement</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">profile</span> <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, the last thing to cover is an important one: tidying up. Chances are that you don&rsquo;t want to stub out your methods for all the tests, and you want to restore them to how they were before at some point. Myrtle makes this super easy.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// if you have a reference to the API object:</span>
</span><span class='line'><span class="nx">info</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// and even if you don&#39;t, remember that</span>
</span><span class='line'><span class="c1">// Myrtle will give you it easily.</span>
</span><span class='line'><span class="nx">Myrtle</span><span class="p">(</span><span class="nx">Obj</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">).</span><span class="nx">release</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// and if you&#39;re really lazy, just clean them all up!</span>
</span><span class='line'><span class="nx">Myrtle</span><span class="p">.</span><span class="nx">releaseAll</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// if you&#39;re not sure if you&#39;ve left</span>
</span><span class='line'><span class="c1">// some hanging about, just check!</span>
</span><span class='line'><span class="nx">Myrtle</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, like I said, the code is on <a href="https://github.com/spadgos/myrtle">Github</a>. Go have look and let me know what you think!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/24/unix-timestamp-confusion/">Unix Timestamp Confusion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-24T23:46:00+02:00" pubdate data-updated="true">Sep 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There seems to be quite some confusion when it comes to working with dates and Unix timestamps, especially when there are multiple timezones involved. I thought I would write up a bit of an explanation to help clarify the situation, and show some of the better ways to deal with this in PHP.</p>

<p>First up, some background information:</p>

<p>A Unix timestamp (or POSIX timestamp) is a measure of time, counted as a single number, representing the number of seconds since Unix Epoch, which was Midnight, 1st January 1970 UTC &ndash; continuously counting upwards from then, <em>kind of</em>. <a href="http://en.wikipedia.org/wiki/Leap_second">Leap seconds</a> are dealt with by <a href="http://en.wikipedia.org/wiki/Unix_timestamp#Encoding_time_as_a_number">repeating a value</a>, but for our purposes you can imagine it as a linear measure of time.</p>

<blockquote><p><strong>The important thing is that no matter what the clock on the wall says, no matter where you are in the world, the Unix timestamp is the same.</strong></p></blockquote>

<p>PHP uses this Unix time for all its date handling, and you can find similar constructs in many other programming languages. Here are some common PHP functions for getting and displaying the time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">time();                   // gets the current Unix timestamp</span>
</span><span class='line'><span class="x">date($format[, $time]);   // display the given time using</span>
</span><span class='line'><span class="x">                          // $format and the server&#39;s timezone</span>
</span><span class='line'><span class="x">                          // information</span>
</span><span class='line'><span class="x">gmdate($format[, $time]); // display the given time using</span>
</span><span class='line'><span class="x">                          // $format, assuming GMT timezone.</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many benefits of encoding a date like this, but the top two would have to be for storage (a single 32-bit integer can handle all dates from December 1901 until January 2038), and for arithmetic purposes. However, the easiness by which you can mutate and play with a date is what often leads newcomers astray.</p>

<p>Here&rsquo;s an example of a good use of date arithmetic: Let&rsquo;s say you want to know what time it will be 47 minutes in the future.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">$now = time();</span>
</span><span class='line'><span class="x">$future = $now + 47 * 60; // 47 minutes = 47 * 60 seconds</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo date(&#39;H:i:s&#39;, $now);       // 14:35:55</span>
</span><span class='line'><span class="x">echo date(&#39;H:i:s&#39;, $future);    // 15:23:55</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy!</p>

<p>Now here&rsquo;s the trap. I live in Brisbane (GMT+10) (and let&rsquo;s say my server is there too), but I want to display the local time for a user who is in Paris (GMT+1). The naive approach is to simply look at the difference between the server&rsquo;s timezone and the user&rsquo;s timezone and adjust the timestamp accordingly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">$serverTimezone = 10;</span>
</span><span class='line'><span class="x">$userTimezone = 1;</span>
</span><span class='line'>
</span><span class='line'><span class="x">$hoursDifference = $serverTimezone - $userTimezone;</span>
</span><span class='line'>
</span><span class='line'><span class="x">$serverTime = time();</span>
</span><span class='line'><span class="x">$userTime = $serverTime - $hoursDifference * 60 * 60;</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo &quot;Brisbane: &quot; . date(&quot;H:i:s&quot;, $serverTime); // 14:35:55</span>
</span><span class='line'><span class="x">echo &quot;Paris: &quot;    . date(&quot;H:i:s&quot;, $userTime)    // 05:35:55</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect! Easy right? <strong>No!</strong> Remember the one important thing about Unix timestamps: <strong>no matter where you are in the world, no matter what hour of the day it is, it is still the same time and hence, the Unix timestamp is the same!</strong> Paris isn&rsquo;t living 9 hours in the past, it&rsquo;s just that their clocks are set nine hours behind mine.</p>

<p>But, who cares? It works right? Yep&hellip; except when it doesn&rsquo;t.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">$serverTime = mktime(10, 59, 30, 3, 29, 2009);</span>
</span><span class='line'><span class="x">$userTime = $serverTime - $hoursDifference * 60 * 60;</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo &quot;Brisbane: &quot; . date(&quot;H:i:s&quot;, $serverTime); // 10:59:30</span>
</span><span class='line'><span class="x">echo &quot;Paris: &quot;    . date(&quot;H:i:s&quot;, $userTime)    // 01:59:30</span>
</span><span class='line'>
</span><span class='line'><span class="x">// one minute later</span>
</span><span class='line'><span class="x">$serverTime = mktime(11, 0, 30, 3, 29, 2009);</span>
</span><span class='line'><span class="x">$userTime = $serverTime - $hoursDifference * 60 * 60;</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo &quot;Brisbane: &quot; . date(&quot;H:i:s&quot;, $serverTime); // 11:00:30</span>
</span><span class='line'><span class="x">echo &quot;Paris: &quot;    . date(&quot;H:i:s&quot;, $userTime)    // 02:00:30</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, it looks good, but it is forgetting one thing. In between these two times (one minute apart), all diligent and insomniac Parisians set their clocks forward an hour because of daylight savings. The time your user would want to see is actually 3:00:30, which is exactly one minute after 1:59:30 on that day.</p>

<p><strong>The better approach:</strong></p>

<p>When using the <code>date()</code> function, PHP formats the time according to its default timezone settings. The easiest way to find the current clock-time at any given location is to change the timezone settings. This means that all the naive conversions you were doing before are now unnecessary, and it will be robust to any peculiarities such as daylight savings. In the future, should France decide to move to a different timezone, your code won&rsquo;t need any changing either! (Though, the server might need to update its OS/PHP version or something).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">// this would be set by default in your php.ini file</span>
</span><span class='line'><span class="x">date_default_timezone_set(&#39;Australia/Brisbane&#39;);</span>
</span><span class='line'><span class="x">$time = mktime(10, 59, 30, 3, 29, 2009);</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo date(&quot;H:i:s&quot;, $time); // 10:59:30</span>
</span><span class='line'>
</span><span class='line'><span class="x">date_default_timezone_set(&#39;Europe/Paris&#39;);</span>
</span><span class='line'>
</span><span class='line'><span class="x">echo date(&quot;H:i:s&quot;, $time);      // 01:59:30</span>
</span><span class='line'><span class="x">echo date(&quot;H:i:s&quot;, $time + 60); // 03:00:30</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember that time is constant in the universe across earth, and that a Unix timestamp is a good-enough measure of that time, and that it has nothing to do with what your clock tells you. Changing your clock because of where you are on Earth doesn&rsquo;t affect the passage of time, and therefore altering time to get the desired clock-time is the wrong way to do things. The only time you should be using arithmetic on a timestamp is when you are actually interested in a different point in time.</p>

<p>Follow this basic guideline and you&rsquo;ll avoid a lot of headaches when dealing with different timezones.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/19/using-requirejs-and-make-for-standalone-libraries/">Using RequireJS and Make for standalone libraries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/01/soundclouds-stack-slides-from-fluentconf-and-sfjs/">SoundCloud&#8217;s Stack: Slides from FluentConf and SFJS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/25/citysonar/">CitySonar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/01/csspecific-plugin-for-sublimetext/">CSSpecific plugin for SublimeText</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/30/a-soundcloud-plugin-for-jekyll-slash-octopress/">A SoundCloud plugin for Jekyll/Octopress</a>
      </li>
    
  </ul>
</section>

<section>
  
  <iframe width="100%" height="450" scrolling="no" frameborder="no" src="http://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Fusers%2F6431392%2Ffavorites&amp;auto_play=false&amp;show_artwork=false&amp;color=ff7700"></iframe>
</section>


<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/spadgos">@spadgos</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'spadgos',
            count: 5,
            skip_forks: true,
            target: '#gh_repos',
            ignore: 'spadgos.github.com'.split(" ")
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Stack Overflow</h1>
  <a href="http://stackoverflow.com/users/9021/nickf"
    ><img src="http://stackoverflow.com/users/flair/9021.png" width="208" height="58" alt="Profile for nickf at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="Profile for nickf at Stack Overflow, Q&amp;A for professional and enthusiast programmers" /></a>
  <ul id="so_answer">
    <li class="loading">Loading recent answers&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      if (!window.jXHR){
        var jxhr = document.createElement('script');
        jxhr.type = 'text/javascript';
        jxhr.src = '/javascripts/libs/jXHR.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(jxhr, s);
      }

      $.ajax({
        type: 'jsonp',
        jsonpCallback: 'jsonp',
        url: 'http://api.stackoverflow.com/1.1/users/9021/answers'
           + '?body=false'
           + '&comments=false'
           + '&method=get'
           + '&pagesize=5'
           + '&jsonp=cb'
           + '&key=TPz4ZgIuDUiQCrMIEyBIPw'
        , success: function(data) {
          if (!data || !data.answers) { return; }
          var i, fragment = '', t = $('#so_answer')[0], a, d;

          fragment = '<li>Recent answers on Stack Overflow</li>';
          for (i = 0; i < data.answers.length; ++i) {
            a = data.answers[i];
            // d = new Date(a.creation_date);
            fragment += '<li><a href="http://stackoverflow.com/questions/' + a.question_id + '/' + a.answer_id + '#' + a.answer_id + '">' + a.title + '</a></li>';
          }
          t.innerHTML = fragment;
        }
      });
    });
  </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Nick Fisher -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'spadgos-gh';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
